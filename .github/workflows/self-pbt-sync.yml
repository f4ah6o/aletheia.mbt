name: "Self PBT Sync"

on:
  workflow_dispatch:
  push:
    paths:
      - ".github/workflows/self-pbt-sync.yml"
      - "moon.mod.json"
      - "src/**"
      - "scripts/self_pbt.sh"
  pull_request:
    paths:
      - ".github/workflows/self-pbt-sync.yml"
      - "moon.mod.json"
      - "src/**"
      - "scripts/self_pbt.sh"

jobs:
  self-pbt-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up MoonBit
        run: |
          curl -fsSL https://cli.moonbitlang.com/install/unix.sh | bash
          echo "$HOME/.moon/bin" >> $GITHUB_PATH

      - name: Update MoonBit dependencies
        run: |
          moon version --all
          moon update

      - name: Run self PBT sync
        run: |
          ./scripts/self_pbt.sh
          if ! git diff --exit-code; then
            echo "::error::PBT generated files are not properly formatted!"
            echo "::error::Please run './scripts/self_pbt.sh' and commit the changes."
            echo "::error::Or run 'moon fmt' on the changed files."
            git diff --color=always
            exit 1
          fi
