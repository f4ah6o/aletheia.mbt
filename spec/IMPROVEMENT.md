# aletheia PBT 生成ワークフロー改善案：実装の整理

**aletheia** のワークフロー改善において、`moonbitlang/quickcheck`（以下 **qc**）の標準機能で実現可能なものと、**aletheia** 側での実装や工夫が必要なものを整理しました。

---

## 1. 利用可能な機能（qc に標準実装されているもの）

**qc** は Haskell の QuickCheck をベースに MoonBit の型システムへ最適化されており、多くの提案内容を標準コンビネータで実現可能です。

* ### 不変条件（Invariants）とモデル化（Modeling）の検証
    * **機能:** `qc.quick_check_fn` を使用して、`(T) -> Bool` の形式でプロパティを記述可能。
    * **活用:** 「ソートしても長さが変わらない」不変条件や、標準ライブラリを比較対象とする「神託（Oracle）」パターンをそのまま実行できます。

* ### 統計情報の収集（Metrics）
    * **機能:** `classify`, `label`, `collect` をサポート。
    * **活用:** 生成データの分布（空リストの割合、数値の範囲など）をテスト結果とともに表示し、テストの質を可視化します。

* ### 頻度指定（Frequency）と選択（One-of）
    * **機能:** `frequency` および `one_of` コンビネータが利用可能。
    * **活用:** 特定のエッジケース（0や特殊文字など）の発生確率を意図的に高めたカスタムジェネレーターを構築できます。

* ### サイズ制御（Size parameter）
    * **機能:** `sized` コンビネータによる生成データの複雑さ制御。
    * **活用:** 深すぎるツリーや長すぎる配列を避けつつ、テストの進行に合わせて徐々に複雑なデータを生成する調整が可能です。

* ### 条件付きプロパティ（Conditional Properties）
    * **機能:** `filter` 関数により、特定の条件を満たす入力のみをテスト対象に設定。

---

## 2. 工夫が必要、または aletheia 側で補完すべき機能

Erlang の PropEr 等に存在するマクロ的機能は、MoonBit のトレイトシステムに基づいた実装に置き換える必要があります。

* ### 収縮のヒント（?SHRINK / ?LETSHRINK 相当）
    * **qc の仕様:** `Shrink` トレイトを実装することで収縮ロジックを定義します。PropEr のようなマクロは直接的には存在しません。
    * **対応案:** **aletheia** が生成するテンプレートで、ユーザーに `Shrink` トレイトの独自実装を促すか、`Iter` を返すカスタム収縮関数の雛形を生成します。

* ### ステートフル PBT のランタイム
    * **qc の仕様:** 現状のドキュメントではステートレスな関数テストが中心です。
    * **対応案:** **aletheia** 自体が既に `state_machine` モジュール等を実装済みのため、提案した「シム（Shim）」の導入などは **aletheia** 側のテンプレート生成ロジックとして実装します。

---

## 機能対応まとめ表

| 提案カテゴリ | 提案項目 | qc での対応機能 | 判定 |
| :--- | :--- | :--- | :---: |
| **パターン** | 不変条件・モデル化の自動提案 | `quick_check_fn` | ✅ |
| **統計** | `collect` / `classify` の埋め込み | `collect`, `classify` | ✅ |
| **分布** | 境界値の頻度を高める生成器 | `frequency`, `one_of` | ✅ |
| **収縮** | 複雑な構造の収縮ヒント | `Shrink` トレイト実装 | ⚠️(※1) |
| **状態管理** | シム（Shim）モジュールの推奨 | **aletheia** 側で実装 | ✅(※2) |

> **(※1)** トレイトの実装が必要なため、マクロほど簡便ではない。  
> **(※2)** qc の核心機能というより、**aletheia** のコード生成ワークフローでカバーする範囲。

---

### 結論
**aletheia** のワークフロー改善において、**qc** が持つ `frequency` による分布制御と `collect` / `classify` による可視化をデフォルトテンプレートに組み込むことが、最も即効性の高い改善ポイントとなります。
