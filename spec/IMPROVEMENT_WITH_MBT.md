# aletheia 改善案

## 1. プロパティ・パターンの拡充：不変条件とモデル化の導入
現在 **aletheia** は Round-Trip などの基本パターンを検出しますが、テキストが推奨する以下の戦略をテンプレート生成に追加することで、テストの質を向上させます。

* **不変条件（Invariants）パターンの自動提案:**
    * **知見:** ソートしてもリストの長さは変わらない、などの「常に真となる性質」を検証する。
    * **改善:** コレクションを操作する関数（`push`, `sort`, `filter` 等）を検出した際、`length` が不変、あるいは特定の範囲に収まることを検証する `qc.quick_check_fn` テンプレートを自動生成します。

* **モデル化（Modeling / Oracle）パターンの提案:**
    * **知見:** 複雑な実装を、自明に正しいが非効率な「モデル」と比較する。
    * **改善:** 複雑なアルゴリズム（例：独自のソート）に対し、標準ライブラリ（例：`@array.sort`）を「神託（Oracle）」として利用する比較テストの雛形を生成します。

---

## 2. ジェネレーター生成の高度化：統計収集と分布制御
テキストでは、デフォルトのジェネレーターだけではエッジケースを網羅できない限界が指摘されています。

* **統計情報（Metrics）のデフォルト埋め込み:**
    * **知見:** `collect` や `aggregate` を使い、生成データの分布を確認することが重要。
    * **改善:** 生成されるテストコードに `qc.classify` や `qc.collect` を標準で含め、空配列や極端な値がどの程度の割合でテストされているかを表示させます。

* **頻度指定（Frequency）ジェネレーターの活用:**
    * **知見:** `frequency` を使い、特定のエッジケース（0、空文字、特殊文字等）が発生する確率を意図的に高める。
    * **改善:** 文字列や数値の引数に対し、`qc.frequency` を用いて「正常値80%、空値10%、境界値10%」といった構成のカスタムジェネレーター・テンプレートを生成します。

---

## 3. 故障診断と収縮（Shrinking）への配慮
テキストでは、失敗したテストケースを「収縮」してデバッグを容易にすることがPBTの核心とされています。

* **反例の可視化とデバッグガイダンス:**
    * **知見:** 収縮された最小の反例はバグの核心を突き止める鍵となる。
    * **改善:** **aletheia** が同期する Markdown ファイル（`.pbt.mbt.md`）に、テスト失敗時に反例を記録・分析するためのコメントセクションを自動生成します。

* **収縮のヒント（?SHRINK / ?LETSHRINK）の提案:**
    * **知見:** 複雑なデータ構造では、収縮が適切に進むようヒントを与える必要がある。
    * **改善:** 独自の列挙型（Enum）や構造体に対し、MoonBit の `Shrink` トレイトの実装を促す、あるいは `let_shrink` を使ったカスタム収縮ロジックの雛形を提供します。

---

## 4. ステートフルPBTワークフローの洗練：シムの導入
**aletheia** は既に状態マシンテストに対応していますが、大規模システムの結合テストには以下の概念が有効です。

* **シム（Shim）モジュールの推奨:**
    * **知見:** 実際のシステムをモデルに適合させるため、非決定的な値をラップしたり、コンテキストを付加する「シム」が重要。
    * **改善:** `state_machine` パターンの生成時、実システムを直接呼ぶのではなく、サイドエフェクトを制御するための Shim 抽象レイヤーを作成するようユーザーに促す構成にします。

* **決定論的モデルの強調:**
    * **知見:** 運用担当者が理解できる単純な「メンタルモデル」をコード化する。
    * **改善:** 内部状態（`initial_state_data`）と状態遷移（`next_state_data`）を分離し、副作用のないモデルの更新を定義する MoonBit の `PropCheck.StateM` インターフェイスに準拠したテンプレートを生成します。

---

これらの改善により、**aletheia** は単なる「コード生成ツール」から、開発者が **「システムの不変条件を深く洞察する」** ための強力なパートナーへと進化します。
